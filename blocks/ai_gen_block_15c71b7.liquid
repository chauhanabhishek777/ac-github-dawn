{% doc %}
  @prompt
    Create an add-to-cart button for the product page that adds products to the cart using AJAX (Shopify Cart API). The button should add the product to cart without refreshing the page, provide visual feedback when clicked, and update the cart count dynamically.
    
    only normal button no css needed i will do that 
{% enddoc %}
{% assign ai_gen_id = block.id | replace: '_', '' | downcase %}

{% style %}
  .ai-ajax-cart-button-{{ ai_gen_id }} {
    display: block;
    width: {{ block.settings.desktop_width_percent }}%;
  }

  .ai-ajax-cart-button-{{ ai_gen_id }}__btn {
    width: 100%;
    padding: 12px 24px;
    border: none;
    cursor: pointer;
    position: relative;
  }

  .ai-ajax-cart-button-{{ ai_gen_id }}__btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .ai-ajax-cart-button-{{ ai_gen_id }}__text {
    display: inline-block;
  }

  .ai-ajax-cart-button-{{ ai_gen_id }}__btn.loading .ai-ajax-cart-button-{{ ai_gen_id }}__text {
    visibility: hidden;
  }

  .ai-ajax-cart-button-{{ ai_gen_id }}__spinner {
    display: none;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 20px;
    height: 20px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top-color: #fff;
    border-radius: 50%;
    animation: ai-ajax-cart-button-spin-{{ ai_gen_id }} 0.6s linear infinite;
  }

  .ai-ajax-cart-button-{{ ai_gen_id }}__btn.loading .ai-ajax-cart-button-{{ ai_gen_id }}__spinner {
    display: block;
  }

  @keyframes ai-ajax-cart-button-spin-{{ ai_gen_id }} {
    to {
      transform: translate(-50%, -50%) rotate(360deg);
    }
  }

  .ai-ajax-cart-button-{{ ai_gen_id }}__message {
    margin-top: 10px;
    padding: 10px;
    border-radius: 4px;
    text-align: center;
    display: none;
  }

  .ai-ajax-cart-button-{{ ai_gen_id }}__message.success {
    display: block;
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .ai-ajax-cart-button-{{ ai_gen_id }}__message.error {
    display: block;
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }
{% endstyle %}

<ajax-cart-button-{{ ai_gen_id }} class="ai-ajax-cart-button-{{ ai_gen_id }}" {{ block.shopify_attributes }}>
  <button
    type="button"
    class="ai-ajax-cart-button-{{ ai_gen_id }}__btn"
    data-product-id="{{ product.selected_or_first_available_variant.id }}"
  >
    <span class="ai-ajax-cart-button-{{ ai_gen_id }}__text">{{ block.settings.button_text }}</span>
    <span class="ai-ajax-cart-button-{{ ai_gen_id }}__spinner"></span>
  </button>
  <div class="ai-ajax-cart-button-{{ ai_gen_id }}__message" role="status" aria-live="polite"></div>
</ajax-cart-button-{{ ai_gen_id }}>

<script>
  (function() {
    class AjaxCartButton{{ ai_gen_id }} extends HTMLElement {
      constructor() {
        super();
        this.button = this.querySelector('.ai-ajax-cart-button-{{ ai_gen_id }}__btn');
        this.message = this.querySelector('.ai-ajax-cart-button-{{ ai_gen_id }}__message');
      }

      connectedCallback() {
        this.button.addEventListener('click', this.handleAddToCart.bind(this));
        
        if (typeof Shopify !== 'undefined' && Shopify.designMode) {
          document.addEventListener('shopify:section:select', this.updateVariantId.bind(this));
        }
      }

      updateVariantId() {
        const variantId = this.button.getAttribute('data-product-id');
        if (variantId) {
          this.button.setAttribute('data-product-id', variantId);
        }
      }

      async handleAddToCart(event) {
        event.preventDefault();
        
        const variantId = this.button.getAttribute('data-product-id');
        
        if (!variantId) {
          this.showMessage('Please select a product variant', 'error');
          return;
        }

        this.button.classList.add('loading');
        this.button.disabled = true;
        this.hideMessage();

        const formData = {
          items: [{
            id: variantId,
            quantity: {{ block.settings.quantity }}
          }]
        };

        try {
          const response = await fetch('/cart/add.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.description || 'Failed to add to cart');
          }

          const data = await response.json();
          
          this.showMessage('{{ block.settings.success_message }}', 'success');
          
          this.updateCartCount();
          
          this.dispatchCartUpdateEvent(data);

        } catch (error) {
          this.showMessage(error.message || 'Failed to add to cart', 'error');
        } finally {
          this.button.classList.remove('loading');
          this.button.disabled = false;
        }
      }

      async updateCartCount() {
        try {
          const response = await fetch('/cart.js');
          const cart = await response.json();
          
          document.querySelectorAll('[data-cart-count]').forEach(element => {
            element.textContent = cart.item_count;
          });

          document.dispatchEvent(new CustomEvent('cart:updated', {
            detail: { cart }
          }));
        } catch (error) {
          console.error('Failed to update cart count:', error);
        }
      }

      dispatchCartUpdateEvent(data) {
        document.dispatchEvent(new CustomEvent('cart:item-added', {
          detail: { items: data.items }
        }));
      }

      showMessage(text, type) {
        this.message.textContent = text;
        this.message.className = 'ai-ajax-cart-button-{{ ai_gen_id }}__message ' + type;
        
        if (type === 'success') {
          setTimeout(() => {
            this.hideMessage();
          }, {{ block.settings.message_duration | times: 1000 }});
        }
      }

      hideMessage() {
        this.message.className = 'ai-ajax-cart-button-{{ ai_gen_id }}__message';
        this.message.textContent = '';
      }
    }

    customElements.define('ajax-cart-button-{{ ai_gen_id }}', AjaxCartButton{{ ai_gen_id }});
  })();
</script>

{% schema %}
{
  "name": "AJAX add to cart",
  "settings": [
    {
      "type": "header",
      "content": "Button"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text",
      "default": "Add to cart"
    },
    {
      "type": "range",
      "id": "quantity",
      "label": "Quantity",
      "min": 1,
      "max": 10,
      "step": 1,
      "default": 1
    },
    {
      "type": "range",
      "id": "desktop_width_percent",
      "label": "Desktop width",
      "min": 50,
      "max": 100,
      "step": 5,
      "unit": "%",
      "default": 100
    },
    {
      "type": "header",
      "content": "Messages"
    },
    {
      "type": "text",
      "id": "success_message",
      "label": "Success message",
      "default": "Added to cart!"
    },
    {
      "type": "range",
      "id": "message_duration",
      "label": "Success message duration",
      "min": 1,
      "max": 10,
      "step": 1,
      "unit": "s",
      "default": 3
    }
  ],
  "presets": [
    {
      "name": "AJAX add to cart"
    }
  ]
}
{% endschema %}
